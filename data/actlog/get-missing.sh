#!/bin/bash
psql -U postgres -t  tmcpe_test -c "select section_id,mintime,maxtime from (select cad,section_id, mintime,maxtime,case when good = 0 THEN 10000000000000 ELSE 1.0*bad/good END as ratio from ( select * from find_data_gaps2 where mintime > '2009-03-01') q order by mintime asc,cad) qq where ratio>.95" | perl -F'/\s*\|\s*/'  -ane 'my @args = map { s/^\s*//g;chomp($_);$_ } @F; system "ssh crindt\@localhost cd pems \\\; perl push-pems-5min.pl --vds=$args[0] --from=\\\"$args[1]\\\" --to=\\\"$args[2]\\\"\n" if ( @args && $args[1] ne "" && $args[2] ne "" );'

for inc in `psql -U postgres -t  tmcpe_test -c "select cad from ( select start_time,start_time::date as date,cad,case when good = 0 THEN 10000000000000 ELSE 1.0*bad/good END as ratio from ( select * from find_data_gaps where start_time > '2009-03-01' ) q order by ratio desc,start_time asc ) qq where qq.ratio>.95"`; do echo RUNNING $inc; perl import-al.pl --dc-vds-downstream-fudge=1.5 --dc-vds-upstream-fallback=6 --dc-prewindow=20 --dc-postwindow=90 --date-from=2010-07-15 --dc-use-eq4567 --dc-use-eq3 --dc-min-obs-pct=20 --dc-limit-loading-shockwave=20 --dc-limit-clearing-shockwave=20 --dc-use-eq8 --dc-use-eq8b --dc-unknown-evidence-value=0.50 --dc-dont-compute-vds-upstream-fallback --dc-band=1 not-40-1210 --verbose --use-osm-geom --only-sigalerts --dc-cplex-optcr=0 --dc-gams-reslim=500 --dc-weight-for-distance=3 --dc-bound-incident-time not-505-031509 --verbose --replace-existing --skip-al-import --skip-rl-import --skip-icad-import $inc; done
