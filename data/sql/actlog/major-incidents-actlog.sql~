DROP VIEW IF EXISTS sigalerts CASCADE;
CREATE VIEW sigalerts AS
SELECT DISTINCT cad 
       FROM ct_al_backup_2007 
       WHERE activitysubject='SIGALERT BEGIN' AND cad <> '';


DROP TYPE IF EXISTS location_parse CASCADE;
CREATE TYPE LOCATION_PARSE AS (
       f1dir TEXT,
       f1net TEXT,
       f1fac TEXT,
       relloc TEXT,
       f2dir TEXT,
       f2net TEXT,
       f2fac TEXT,
       xs    TEXT,
       f3dir TEXT,
       f3net TEXT,
       f3fac TEXT
);

CREATE LANGUAGE PLPERL;
DROP FUNCTION IF EXISTS parse_al_memo( memo TEXT ) CASCADE;
CREATE FUNCTION parse_al_memo( memo TEXT ) RETURNS LOCATION_PARSE AS
---CREATE FUNCTION parse_al_memo( memo TEXT ) RETURNS TEXT[] AS
$$
	$_ = $_[0];
#	our @fwys = grep { $_ ne '' } ( $_ =~ /([NSEW]+)B*[- ]([^\d]*?)[- ]*(\d+)/ );
	$res;
	our @blocks = ( $_ =~ /(.*)(J[NSEW]O)(.*)/g );
	our @blocks = ( $_ =~ /(.*)(AT)(.*)/g ) if not @blocks;
	our ($f1dir,$f1net,$f1fac) = ( $blocks[0] =~ /([NSEW]+)B*[- ]([^\d]*?)[- ]*(\d+)/ );
	$res->{f1dir} = $f1dir;
	$res->{f1net} = $f1net;
	$res->{f1fac} = $f1fac;
	our ($f2dir,$f2net,$f2fac) = ( $blocks[2] =~ / ([NSEW]+)B*[- ]([^\d]*?)[- ]*(\d+)/ );
	$res->{relloc} = $blocks[1];
	$res->{f2dir} = $f2dir;
	$res->{f2net} = $f2net;
	$res->{f2fac} = $f2fac;
	our @xs = ( $blocks[2] =~ /\s*(.*?)[-,\.]/ );
	$res->{xs} = join( ":", @xs );
	our $xxs = join( " ", @xs );
	our ($f3dir,$f3net,$f3fac) = ( $xxs =~ / ([NSEW]+)B*[- ]([^\d]*?)[- ]*(\d+)/ );
	$res->{f3dir} = $f3dir;
	$res->{f3net} = $f3net;
	$res->{f3fac} = $f3fac;
#	return join( "---", join(":", @fwy1 ), $blocks[1], join(":", @fwy2 ), join( ":", @xs ), join(":", @fwy3 ) );
#	return [ join(":", @fwy1 ), $blocks[1], join(":", @fwy2 ), join( ":", @xs ), join(":", @fwy3 ) ];
#	return { f1dir => $f1dir,
#	         f1net => $f1net,
#	         f1fac => $f1fac,
#		 relloc => $blocks[1],
#		 f1dir => $fwy2[0],
#	         f1net => $fwy2[1],
#	         f1fac => $fwy2[2],
#		 xs    => join( ":", @xs ),
#		 f1dir => $fwy3[0],
#	         f1net => $fwy3[1],
#	         f1fac => $fwy3[2] };
        return $res;
$$ LANGUAGE plperl;


DROP VIEW IF EXISTS locate_sigalerts CASCADE;
CREATE VIEW locate_sigalerts AS
SELECT cad,memo,parse_al_memo( memo ) as lp
       FROM ct_al_backup_2007 
       WHERE activitysubject='OPEN INCIDENT' AND cad IN ( SELECT cad from sigalerts );

DROP TABLE IF EXISTS sigalert_list;
SELECT cad,(lp).f1dir as f1dir,(lp).f1fac as f1fac,(lp).relloc as relloc,(lp).xs as xs,(lp).f2dir as f2dir,(lp).f2fac as f2fac 
       INTO sigalert_list
       FROM locate_sigalerts 
       WHERE (lp).f1dir IS NOT NULL AND (lp).relloc IS NOT NULL 
       	     AND (((lp).xs IS NOT NULL AND (lp).xs <> '' ) 
       	     	  OR ( (lp).f2dir IS NOT NULL AND (lp).f2fac IS NOT NULL ) );
